const sharp = require('sharp');
const fs = require('fs');

const inputPath = process.argv[2];
const outputPath = 'processed_image.jpg';

if (!inputPath) {
  console.error('âŒ è¯·æä¾›å›¾ç‰‡è·¯å¾„: node scripts/edit_image.js <image_path>');
  process.exit(1);
}

async function processImage() {
  try {
    console.log(`ğŸ¨ æ­£åœ¨å¤„ç†å›¾ç‰‡: ${inputPath}...`);
    
    // è·å–å›¾ç‰‡å…ƒæ•°æ®ä»¥ç¡®å®šå°ºå¯¸
    const metadata = await sharp(inputPath).metadata();
    const width = metadata.width;
    const height = metadata.height;

    // åˆ›å»ºä¸€ä¸ª SVG æ–‡å­—æ°´å° (å±…ä¸­ï¼Œçº¢è‰²ï¼ŒåŠé€æ˜)
    // å­—ä½“å¤§å°æ ¹æ®å›¾ç‰‡å®½åº¦è‡ªé€‚åº”
    const fontSize = Math.floor(width * 0.05); 
    const svgText = `
      <svg width="${width}" height="${height}">
        <style>
          .title { fill: red; fill-opacity: 0.5; font-size: ${fontSize}px; font-weight: bold; font-family: sans-serif; }
        </style>
        <text x="50%" y="95%" text-anchor="middle" class="title">Generated by Cascade</text>
        <text x="50%" y="50%" text-anchor="middle" class="title" transform="rotate(-45, ${width/2}, ${height/2})">CONFIDENTIAL</text>
      </svg>
    `;

    await sharp(inputPath)
      .composite([
        {
          input: Buffer.from(svgText),
          top: 0,
          left: 0,
        },
      ])
      .toFile(outputPath);

    console.log(`âœ… å›¾ç‰‡å¤„ç†å®Œæˆ! å·²ä¿å­˜ä¸º: ${outputPath}`);
    
  } catch (error) {
    console.error('âŒ å›¾ç‰‡å¤„ç†å¤±è´¥:', error.message);
  }
}

processImage();
