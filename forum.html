<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>墨西哥华人论坛｜发布招聘、租房、二手、合作信息</title>
  <meta name="description" content="墨西哥华人论坛开放发布，无需登录即可发布招聘、租房、二手、合作与活动信息，快速被同城华人看到。">
  <link rel="canonical" href="https://mxchino.com/forum">
  <meta property="og:title" content="墨西哥华人论坛｜发布招聘、租房、二手、合作信息">
  <meta property="og:description" content="无需登录即可发布信息，快速被同城华人看到。招聘、租房、二手、合作与活动都可以发。">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://mxchino.com/forum">
  <meta property="og:site_name" content="墨西哥华人网">
  <meta property="og:image" content="https://mxchino.com/assets/pexels-rickyrecap-1720086.jpg">
  <meta property="og:image:alt" content="墨西哥华人论坛">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="墨西哥华人论坛｜发布招聘、租房、二手、合作信息">
  <meta name="twitter:description" content="无需登录即可发布信息，快速被同城华人看到。">
  <meta name="twitter:image" content="https://mxchino.com/assets/pexels-rickyrecap-1720086.jpg">
  <!--HEAD-->
</head>
<body class="forum">
  <!--HEADER-->
  <main class="page forum-page">
    <section class="forum-hero">
      <div class="forum-hero__content">
        <div class="eyebrow">墨西哥华人网 · 论坛</div>
        <h1>墨西哥华人论坛</h1>
        <p class="muted">无需登录，30 秒内发布。招聘、租房、二手、合作、活动都可以发，信息会立即显示在列表中。</p>
        <div class="forum-hero__chips">
          <span>招聘</span>
          <span>租房</span>
          <span>二手</span>
          <span>合作</span>
          <span>活动</span>
        </div>
      </div>
      <div class="forum-hero__card">
        <h2>发布提醒</h2>
        <ul>
          <li>标题清晰一点，内容写重点。</li>
          <li>联系方式可选，但写了会更容易被联系。</li>
          <li>请勿发布违法、欺诈或重复刷屏内容。</li>
        </ul>
      </div>
    </section>

    <section class="forum-grid">
      <div class="forum-stream">
        <div class="forum-stream__head">
          <div>
            <h2>最新帖子</h2>
            <p class="muted">按照时间排序，发布后立即显示。</p>
          </div>
          <button class="btn ghost" type="button" id="forum-refresh">刷新</button>
        </div>
        <div class="forum-posts" id="forum-posts"></div>
        <div class="forum-empty muted" id="forum-empty" hidden>还没有帖子，欢迎发布第一条信息。</div>
      </div>

      <aside class="forum-form-card">
        <h2>发布信息</h2>
        <form id="forum-form">
          <div class="form-grid">
            <div class="field">
              <label for="title">标题 *</label>
              <input id="title" name="title" type="text" required maxlength="80" placeholder="例如：蒙特雷餐厅招聘前台">
            </div>
            <div class="field">
              <label for="category">分类</label>
              <select id="category" name="category">
                <option value="">综合</option>
                <option value="招聘">招聘</option>
                <option value="求职">求职</option>
                <option value="租房">租房</option>
                <option value="二手">二手</option>
                <option value="合作">合作</option>
                <option value="活动">活动</option>
                <option value="求助">求助</option>
              </select>
            </div>
            <div class="field">
              <label for="city">城市</label>
              <input id="city" name="city" type="text" placeholder="例如：蒙特雷">
            </div>
            <div class="field">
              <label for="contact">联系方式（可选）</label>
              <input id="contact" name="contact" type="text" placeholder="微信 / WhatsApp / 电话">
            </div>
            <div class="field field--span-2">
              <label for="content">内容 *</label>
              <textarea id="content" name="content" required maxlength="2000" placeholder="写清楚时间、地点、要求、价格等关键信息"></textarea>
            </div>
            <div class="field field--hidden">
              <label for="website">网站</label>
              <input id="website" name="website" type="text" tabindex="-1" autocomplete="off">
            </div>
          </div>
          <div class="form-actions">
            <button class="btn primary" type="submit">立即发布</button>
            <div class="note muted">发布即展示，内容越清晰越容易获得回复。</div>
          </div>
          <div class="status" id="forum-status" aria-live="polite"></div>
        </form>
      </aside>
    </section>
  </main>
  <script>
    const apiBase = window.API_BASE
      || (window.location.protocol === 'file:' ? 'http://localhost:3000' : window.location.origin);
    const postsEl = document.getElementById('forum-posts');
    const emptyEl = document.getElementById('forum-empty');
    const refreshBtn = document.getElementById('forum-refresh');
    const form = document.getElementById('forum-form');
    const statusEl = document.getElementById('forum-status');
    const submitBtn = form?.querySelector('button[type="submit"]');

    const showStatus = (msg, type = 'ok') => {
      statusEl.textContent = msg;
      statusEl.className = `status ${type}`;
    };

    const formatTime = (value) => {
      const date = value ? new Date(value) : null;
      if (!date || Number.isNaN(date.getTime())) return '';
      return date.toLocaleString('zh-CN', { hour12: false });
    };

    const createPostCard = (post) => {
      const card = document.createElement('article');
      card.className = 'forum-post';

      const title = document.createElement('h3');
      title.textContent = post.title || '未命名';
      card.appendChild(title);

      const meta = document.createElement('div');
      meta.className = 'forum-post__meta';
      const metaParts = [];
      if (post.category) metaParts.push(`分类：${post.category}`);
      if (post.city) metaParts.push(`城市：${post.city}`);
      const time = formatTime(post.created_at);
      if (time) metaParts.push(time);
      meta.textContent = metaParts.join(' · ');
      card.appendChild(meta);

      const content = document.createElement('div');
      content.className = 'forum-post__content';
      content.textContent = post.content || '';
      card.appendChild(content);

      if (post.contact) {
        const contact = document.createElement('div');
        contact.className = 'forum-post__contact';
        contact.textContent = `联系方式：${post.contact}`;
        card.appendChild(contact);
      }

      return card;
    };

    const renderPosts = (posts) => {
      postsEl.innerHTML = '';
      if (!posts.length) {
        emptyEl.hidden = false;
        return;
      }
      emptyEl.hidden = true;
      posts.forEach((post) => {
        postsEl.appendChild(createPostCard(post));
      });
    };

    const parseJsonSafe = async (res) => {
      const contentType = res.headers.get('content-type') || '';
      if (!contentType.includes('application/json')) {
        return { ok: false, message: '服务未返回 JSON，可能后端未启动' };
      }
      try {
        return await res.json();
      } catch (err) {
        return { ok: false, message: '解析响应失败，检查后端服务' };
      }
    };

    const loadPosts = async () => {
      try {
        const res = await fetch(`${apiBase}/api/forum-posts?limit=80`);
        const data = await parseJsonSafe(res);
        if (!res.ok || !data.ok) throw new Error(data.message || '加载失败');
        renderPosts(data.data || []);
      } catch (err) {
        emptyEl.hidden = false;
        emptyEl.textContent = err.message || '加载失败，请刷新';
      }
    };

    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => {
        refreshBtn.disabled = true;
        loadPosts().finally(() => {
          setTimeout(() => {
            refreshBtn.disabled = false;
          }, 400);
        });
      });
    }

    if (form) {
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        showStatus('提交中…', 'ok');
        submitBtn.disabled = true;

        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());

        try {
          const res = await fetch(`${apiBase}/api/forum-posts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await parseJsonSafe(res);
          if (!res.ok || !data.ok) throw new Error(data.message || '发布失败');
          showStatus('发布成功！', 'ok');
          form.reset();
          await loadPosts();
        } catch (err) {
          showStatus(err.message || '发布失败，请稍后再试', 'error');
        } finally {
          submitBtn.disabled = false;
        }
      });
    }

    loadPosts();
  </script>
  <!--FOOTER-->
</body>
</html>
